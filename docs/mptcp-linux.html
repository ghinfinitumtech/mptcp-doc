<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Using Multipath TCP on recent Linux kernels &mdash; Multipath TCP -- documentation 2022 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/plot_directive.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Multipath TCP on Apple devices" href="mptcp-apple.html" />
    <link rel="prev" title="Multipath TCP" href="mptcp.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="index.html" class="icon icon-home"> Multipath TCP -- documentation
            <img src="_static/mptcp-logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                alpha
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="usecases.html">Use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="tcp.html">The Transmission Control Protocol (TCP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="mptcp.html">Multipath TCP</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Using Multipath TCP on recent Linux kernels</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#enabling-multipath-tcp">Enabling Multipath TCP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#analyzing-the-output-of-ss">Analyzing the output of ss</a></li>
<li class="toctree-l2"><a class="reference internal" href="#analyzing-the-output-of-nstat">Analyzing the output of nstat</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-nstat">Using nstat</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-case-diagrams">The Case diagrams</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#the-multipath-tcp-counters">The Multipath TCP counters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-mpcapable-counters">The MPCapable counters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-join-counters">The Join counters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-address-advertisement-counters">The address advertisement counters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-connection-termination-counters">The connection termination counters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-other-counters">The other counters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#native-multipath-tcp-applications-on-linux">Native Multipath TCP applications on Linux</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mptcp-apple.html">Multipath TCP on Apple devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="biblio.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Multipath TCP -- documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Using Multipath TCP on recent Linux kernels</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/mptcp-apps/mptcp-doc/blob/main/mptcp-linux.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="using-multipath-tcp-on-recent-linux-kernels">
<span id="chapter-linux"></span><h1>Using Multipath TCP on recent Linux kernels<a class="headerlink" href="#using-multipath-tcp-on-recent-linux-kernels" title="Permalink to this headline"></a></h1>
<p>The first version of Multipath TCP on Linux was an off-tree patch intially developed by UCLouvain researchers <span id="id1">[<a class="reference internal" href="biblio.html#id8926" title="Christoph Paasch, Sébastien Barré, and others. Multipath TCP in the Linux kernel. Available from \url http://www.multipath-tcp.org.">40</a>]</span>. This implementation was initially the reference implementation of Multipath TCP. It influenced the design of the protocol as new features were always tested on this implementation. You can find additional information about this implementation on <a class="reference external" href="https://www.multipath-tcp.org">https://www.multipath-tcp.org</a>.</p>
<p>Starting with version 5.6, the official Linux kernel includes support for Multipath TCP. The set of features supported by this implementation has increased over time as shown by its <a class="reference external" href="https://github.com/multipath-tcp/mptcp_net-next/wiki">ChangeLog</a>.</p>
<p>To avoid any interference with regular TCP, this implementation only creates a Multipath TCP connection if the application has created its <code class="docutils literal notranslate"><span class="pre">socket</span></code> using the <code class="docutils literal notranslate"><span class="pre">IPPROTO_MPTCP</span></code> protocol. Applications will probably be modified in the coming months and years to add specific support for Multipath TCP, but in the mean time, the Multipath TCP developers have created a work around to force legacy applications to use Multipath TCP with the <code class="docutils literal notranslate"><span class="pre">mptcpize</span></code> command which is bundled with the <a class="reference external" href="https://intel.github.io/mptcpd/">mptcpd</a> daemon. We use this approach in this section and discuss applications with native Multipath TCP support <a class="reference external" href="native-mptcp-linux">later</a>.</p>
<p>To illustrate Multipath TCP, we use a very simple setup with a Linux client using Ubuntu 22 and a Linux server using Debian. The client uses Linux kernel version 5.15 while the server uses version 5.17. The server has a single network interface with an IPv4 and an IPv6 address. The client has both a Wi-Fi and an Ethernet interface. These two interfaces are connected to the same router that allocates IP addresses in the same subnet on both interfaces. The client has both an IPv4 and an IPv6 address.</p>
<section id="enabling-multipath-tcp">
<h2>Enabling Multipath TCP<a class="headerlink" href="#enabling-multipath-tcp" title="Permalink to this headline"></a></h2>
<p>Multipath TCP is a feature that needs to be compiled inside the kernel. If you compile your own kernel, you can manually select Multipath TCP.</p>
<p>Most users prefer to rely on already compiled Linux kernels that are included in their distribution. The following distributions support Multipath TCP:</p>
<blockquote>
<div><ul class="simple">
<li><p>CentOS starting with</p></li>
<li><p>Debian starting with</p></li>
<li><p>Ubuntu starting with 22.04</p></li>
</ul>
</div></blockquote>
<p>You need to to install a recent kernel to benefit from Multipath TCP. On some distributions, this installation will be part of the regular upgrade. On other distributions, you will need to add it manually.</p>
<p>Once the kernel has been installed and your computer has rebooted, you first need to verify that Multipath TCP is enabled.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo sysctl -a | grep mptcp.enabled</span>
<span class="go">net.mptcp.enabled = 1</span>
</pre></div>
</div>
<p>Here, the kernel supports Multipath TCP. If, for any reason, you want to disable Multipath TCP, you need to set this <code class="docutils literal notranslate"><span class="pre">sysctl</span></code> variable to <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<p>To illustrate the basic operation of <code class="docutils literal notranslate"><span class="pre">mptcpize</span></code>, let us first use the netcat command over the loopback interface. This is obviously not the target use case for Multipath TCP, but a nice way to perform tests.</p>
<p>Netcat allows to easily launch clients and servers. We start the server using: <code class="docutils literal notranslate"><span class="pre">mptcpize</span> <span class="pre">run</span> <span class="pre">nc</span> <span class="pre">-l</span> <span class="pre">-p</span> <span class="pre">12345</span></code>. This is a TCP server that listens on port <code class="docutils literal notranslate"><span class="pre">12345</span></code>. The client connects to this server using the <code class="docutils literal notranslate"><span class="pre">mptcpize</span> <span class="pre">run</span> <span class="pre">nc</span> <span class="pre">127.0.0.1</span> <span class="pre">12345</span></code> command. The connection is established and all text lines sent by the client are printed by the server on standard output.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mptcpize run nc -l -p <span class="m">12345</span>
<span class="go">Simple test</span>
</pre></div>
</div>
<p>There are several ways to check that Multipath TCP is used for this connection. First, the <code class="docutils literal notranslate"><span class="pre">ss</span></code> command provides information about the status of the different sockets.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ss -iaM</span>
<span class="go">State    Recv-Q    Send-Q       Local Address:Port        Peer Address:Port    Process</span>
<span class="go">ESTAB    0         0                127.0.0.1:12345          127.0.0.1:52854</span>
<span class="go">         subflows_max:2 remote_key token:5bba80d9 write_seq:2266a099179e2476 snd_una:2266a099179e2476 rcv_nxt:de9999038d0a29a2</span>
<span class="go">ESTAB    0         0                127.0.0.1:52854          127.0.0.1:12345</span>
<span class="go">         subflows_max:2 remote_key token:c1f12b87 write_seq:de9999038d0a29a2 snd_una:de9999038d0a29a2 rcv_nxt:2266a099179e2476</span>
</pre></div>
</div>
<p>ss provides several useful information to debug a Multipath TCP connection. The first column indicates that the connection is in the Established state, which means that it can currently transfer data. It also indicates the length of the Send and Receive queues at the TCP level and the four-tuple that identifies the connection. The next line provides Multipath TCP information with the maximum number of subflows which can be attached to the connection, the token assigned by the remote host and the write_seq, snd_una and rcv_next parameters of the sate machine. The next two lines provide information about the other direction of the connection.</p>
<p>It is also possible to capture packets on the loopback interface to verify that Multipath TCP is used. The output below provides the first collected packets:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on lo, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span>
<span class="go">18:43:42.676396 IP 127.0.0.1.52854 &gt; 127.0.0.1.12345: Flags [S], seq 904893125, win 65495, options [mss 65495,sackOK,TS val 4026038040 ecr 0,nop,wscale 7,mptcp capable v1], length 0</span>
<span class="go">18:43:42.676426 IP 127.0.0.1.12345 &gt; 127.0.0.1.52854: Flags [S.], seq 1804351310, ack 904893126, win 65483, options [mss 65495,sackOK,TS val 4026038040 ecr 4026038040,nop,wscale 7,mptcp capable v1 {0x45edb502d861e7b1}], length 0</span>
<span class="go">18:43:42.676472 IP 127.0.0.1.52854 &gt; 127.0.0.1.12345: Flags [.], ack 1, win 512, options [nop,nop,TS val 4026038040 ecr 4026038040,mptcp capable v1 {0xdbb760db1d55e07b,0x45edb502d861e7b1}], length 0</span>
<span class="go">18:44:59.519697 IP 127.0.0.1.52854 &gt; 127.0.0.1.12345: Flags [P.], seq 1:13, ack 1, win 512, options [nop,nop,TS val 4026114884 ecr 4026038040,mptcp capable v1 {0xdbb760db1d55e07b,0x45edb502d861e7b1},nop,nop], length 12</span>
<span class="go">18:44:59.519755 IP 127.0.0.1.12345 &gt; 127.0.0.1.52854: Flags [.], ack 13, win 512, options [nop,nop,TS val 4026114884 ecr 4026114884,mptcp dss ack 16040019788386937262], length 0</span>
</pre></div>
</div>
<p>The first packet is the <code class="docutils literal notranslate"><span class="pre">SYN</span></code> that includes the <code class="docutils literal notranslate"><span class="pre">MP_CAPABLE</span></code> option. The server replies with the <code class="docutils literal notranslate"><span class="pre">SYN+ACK</span></code> with the <code class="docutils literal notranslate"><span class="pre">MP_CAPABLE</span></code> containing the server key. The client returns the third <code class="docutils literal notranslate"><span class="pre">ACK</span></code> with the <code class="docutils literal notranslate"><span class="pre">MP_CAPABLE</span></code> and the two keys. As the server did not send any data, the <code class="docutils literal notranslate"><span class="pre">MP_CAPABLE</span></code> option is sent again in the packet containing the <code class="docutils literal notranslate"><span class="pre">Simple</span> <span class="pre">test</span></code> string. This packet also contains the <code class="docutils literal notranslate"><span class="pre">DSS</span></code> option. The server replies with an acknowledgment that carries the <code class="docutils literal notranslate"><span class="pre">DSS</span></code> option.</p>
<p>We can now use the netcat application to explore the operation of Multipath TCP over the Internet. Let us start with a very simple example.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mptcpize run nc serverv4 12345</span>
<span class="go">hello</span>
</pre></div>
</div>
<p>The netcat process listens on port 12345 on the server. This results in the following Multipath TCP connection :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">09:05:23.695876 IP host-78-129-5-171.dynamic.voo.be.41510 &gt; serverv4.12345: Flags [S], seq 3525674027, win 64240, options [mss 1460,sackOK,TS val 2619832768 ecr 0,nop,wscale 7,mptcp capable v1], length 0</span>
<span class="go">09:05:23.696076 IP serverv4.12345 &gt; host-78-129-5-171.dynamic.voo.be.41510: Flags [S.], seq 1745741580, ack 3525674028, win 65160, options [mss 1460,sackOK,TS val 3069340264 ecr 2619832768,nop,wscale 7,mptcp capable v1 {0x82aa42ef4245f0d0}], length 0</span>
<span class="go">09:05:23.707909 IP host-78-129-5-171.dynamic.voo.be.41510 &gt; serverv4.12345: Flags [.], ack 1, win 502, options [nop,nop,TS val 2619832783 ecr 3069340264,mptcp capable v1 {0x9dc8e3972e3d9f25,0x82aa42ef4245f0d0}], length 0</span>
<span class="go">09:05:30.776312 IP host-78-129-5-171.dynamic.voo.be.41510 &gt; serverv4.12345: Flags [P.], seq 1:7, ack 1, win 502, options [nop,nop,TS val 2619839851 ecr 3069340264,mptcp capable v1 {0x9dc8e3972e3d9f25,0x82aa42ef4245f0d0},nop,nop], length 6</span>
<span class="go">09:05:30.776484 IP serverv4.12345 &gt; host-78-129-5-171.dynamic.voo.be.41510: Flags [.], ack 7, win 510, options [nop,nop,TS val 3069347345 ecr 2619839851,mptcp dss ack 1561335003985645838], length 0</span>
</pre></div>
</div>
<p>This is a Multipath TCP connection since it includes the Multipath TCP options, but the client does not create an additional subflow and the server does not announce its other addresses. This is the expected behavior since these operations are controlled by the path manager. On Linux, the Multipath TCP path manager can be configured using the <a class="reference external" href="https://man7.org/linux/man-pages/man8/ip-mptcp.8.html">ip-mptcp</a> command. This command can be used to configure different parameters that are associated to an IP address. The path manager associates a numeric identifier to each IP address or endpoint. The <code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">mptcp</span> <span class="pre">endpoint</span> <span class="pre">show</span></code> command lists the identifiers of the active IP addresses on the host. Here is an example of the output of this command on our client:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ip mptcp endpoint show</span>
<span class="go">fe80::3934:7572:b1ff:b555 id 1 dev wlp3s0</span>
<span class="go">192.168.0.43 id 2 dev wlp3s0</span>
<span class="go">fe80::5642:39bd:3390:43d3 id 3 dev enp2s0</span>
<span class="go">192.168.0.37 id 4 dev enp2s0</span>
<span class="go">2a02:2788:10c4:123:3d66:f590:d891:8fb3 id 5 dev wlp3s0</span>
<span class="go">2a02:2788:10c4:123:6636:10c6:692b:18cc id 6 dev enp2s0</span>
<span class="go">2a02:2788:10c4:123:2a09:5ec7:9b99:4a97 id 7 dev enp2s0</span>
</pre></div>
</div>
<p>The two <code class="docutils literal notranslate"><span class="pre">fe80</span></code> addresses are the IPv6 link local addresses configured on the Ethernet (<code class="docutils literal notranslate"><span class="pre">enp2s0</span></code>) and Wi-Fi (<code class="docutils literal notranslate"><span class="pre">wlp3s0</span></code>) interfaces of our client host. There are three flags which can be associated with each endpoint identifier:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">subflow</span></code>. When this flag is set, the path manager will try to create a subflow over this interface when a Multipath TCP is created or the interface becomes active while there was an ongoing Multipath TCP connection. This flag is mainly useful for clients.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">signal</span></code>. When this flag is set, the path manager will announce the address of the endpoint over any Multipath TCP connection created using other addresses. This flag can be used on clients or servers. It is mainly useful on servers that have multiple addresses.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">backup</span></code>. This flag can be combined with the two other flags. When combined with the <code class="docutils literal notranslate"><span class="pre">subflow</span></code> flag, it indicates that a backup subflow will be created. When combined with the <code class="docutils literal notranslate"><span class="pre">signal</span></code> flag, it indicates that the address will be advertised as a backup address.</p></li>
</ul>
</div></blockquote>
<p>On our client host, we can configure the Wi-Fi interface as a backup interface that creates subflows as follows :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo ip mptcp endpoint del id 2</span>
<span class="go">sudo ip mptcp endpoint add 192.168.0.43 dev wlp3s0 subflow backup</span>
<span class="go">sudo ip mptcp endpoint show</span>
<span class="go">fe80::3934:7572:b1ff:b555 id 1 dev wlp3s0</span>
<span class="go">fe80::5642:39bd:3390:43d3 id 3 dev enp2s0</span>
<span class="go">192.168.0.37 id 4 dev enp2s0</span>
<span class="go">2a02:2788:10c4:123:3d66:f590:d891:8fb3 id 5 dev wlp3s0</span>
<span class="go">2a02:2788:10c4:123:6636:10c6:692b:18cc id 6 dev enp2s0</span>
<span class="go">2a02:2788:10c4:123:2a09:5ec7:9b99:4a97 id 7 dev enp2s0</span>
<span class="go">192.168.0.43 id 8 subflow backup dev wlp3s0</span>
</pre></div>
</div>
<p>We had to first remove the configuration for this endpoint because a default one was already active. Then we added the new parameters and verified them.</p>
<p>The path manager also has some limits which can be configured using the <code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">mptcp</span> <span class="pre">limits</span></code> command. Two limits can be set.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">mptcp</span> <span class="pre">limits</span> <span class="pre">set</span> <span class="pre">subflow</span> <span class="pre">n</span></code> where <code class="docutils literal notranslate"><span class="pre">n</span></code> is an integer. This restricts the Multipath TCP connection to use up to <code class="docutils literal notranslate"><span class="pre">n</span></code> different subflows. Servers should protect themselves by setting this limit to a few subflows. Most use cases would work well with 2 or 4 subflows.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">mptcp</span> <span class="pre">limits</span> <span class="pre">set</span> <span class="pre">add_addr_accepted</span> <span class="pre">n</span></code> where <code class="docutils literal notranslate"><span class="pre">n</span></code> is an integer. This parameter limits the number of addresses that are learned over each Multipath TCP connection. This parameter could be used to protect the Multipath TCP implementation against attacks where two many addresses are advertised. Most use cases would work with 4 accepted addresses.</p></li>
</ul>
</div></blockquote>
<p>These parameters control the path manager, but before creating Multipath TCP subflows over different paths, we need to configure the IP routing table of our client host. Our client host has two network interfaces: Wi-Fi and Ethernet. By default, Linux prefers the Ethernet interface to Wi-Fi. The two interfaces are configured as follows :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ip -4 addr show</span>
<span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span>
<span class="go">    inet 127.0.0.1/8 scope host lo</span>
<span class="go">    valid_lft forever preferred_lft forever</span>
<span class="go">2: enp2s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span>
<span class="go">    inet 192.168.0.37/24 brd 192.168.0.255 scope global dynamic noprefixroute enp2s0</span>
<span class="go">    valid_lft 75697sec preferred_lft 75697sec</span>
<span class="go">3: wlp3s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span>
<span class="go">    inet 192.168.0.43/24 brd 192.168.0.255 scope global dynamic noprefixroute wlp3s0</span>
<span class="go">    valid_lft 75696sec preferred_lft 75696sec</span>
</pre></div>
</div>
<p>By default, Linux creates the two following default routes.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">route -n</span>
<span class="go">Kernel IP routing table</span>
<span class="go">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span>
<span class="go">0.0.0.0         192.168.0.1     0.0.0.0         UG    100    0        0 enp2s0</span>
<span class="go">0.0.0.0         192.168.0.1     0.0.0.0         UG    600    0        0 wlp3s0</span>
</pre></div>
</div>
<p>We need to configure the routing tables to be able to use the two interfaces simultaneously. For this, we need to ensure that packets with source address <code class="docutils literal notranslate"><span class="pre">192.168.0.37</span></code> are sent over the <code class="docutils literal notranslate"><span class="pre">enp2s0</span></code> interface while packets with source address <code class="docutils literal notranslate"><span class="pre">192.168.0.43</span></code> are sent over the <code class="docutils literal notranslate"><span class="pre">wlp3s0</span></code> interface. This can be achieved using two different routing tables.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>create the two routing tables
<span class="go">ip rule add from 192.168.0.37 table 1</span>
<span class="go">ip rule add from 192.168.0.43 table 2</span>

<span class="gp"># </span>Configure routing table <span class="m">1</span> <span class="k">for</span> enp2s0
<span class="go">ip route add 192.168.0.0/24 dev enp2s0 scope link table 1</span>
<span class="go">ip route add default via 192.168.0.1 dev enp2s0 table 1</span>

<span class="gp"># </span>Configure routing table <span class="m">2</span> <span class="k">for</span> wlp3s0
<span class="go">ip route add 192.168.0.0/24 dev wlp3s0 scope link table 2</span>
<span class="go">ip route add default via 192.168.0.1 dev wlp3s0 table 2</span>

<span class="gp"># </span>Configure a default route to regular internet
<span class="go">ip route add default scope global nexthop via 192.168.0.1 dev enp2s0</span>
</pre></div>
</div>
<p>We can check the routing tables using the ip command.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ip rule show</span>
<span class="go">0:   from all lookup local</span>
<span class="go">32764:       from 192.168.0.43 lookup 2</span>
<span class="go">32765:       from 192.168.0.37 lookup 1</span>
<span class="go">32766:       from all lookup main</span>
<span class="go">32767:       from all lookup default</span>

<span class="go">ip route</span>
<span class="go">default via 192.168.0.1 dev enp2s0</span>
<span class="go">default via 192.168.0.1 dev enp2s0 proto dhcp metric 100</span>
<span class="go">default via 192.168.0.1 dev wlp3s0 proto dhcp metric 600</span>
<span class="go">169.254.0.0/16 dev wlp3s0 scope link metric 1000</span>
<span class="go">192.168.0.0/24 dev enp2s0 proto kernel scope link src 192.168.0.37 metric 100</span>
<span class="go">192.168.0.0/24 dev wlp3s0 proto kernel scope link src 192.168.0.43 metric 600</span>

<span class="go">ip route show table 1</span>
<span class="go">default via 192.168.0.1 dev enp2s0</span>
<span class="go">192.168.0.0/24 dev enp2s0 scope link</span>

<span class="go">ip route show table 2</span>
<span class="go">default via 192.168.0.1 dev wlp3s0</span>
<span class="go">192.168.0.0/24 dev wlp3s0 scope link</span>
</pre></div>
</div>
<p>We can verify that the two routing tables are correct using <code class="docutils literal notranslate"><span class="pre">nc</span></code> by forcing it to use a specific source address.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">echo -e &quot;GET / HTTP/1.0\r\n&quot; | nc -4 -s 192.168.0.37 test.multipath-tcp.org 80</span>
<span class="go">HTTP/1.0 200 OK</span>
<span class="go">Content-Type: text/html</span>
<span class="go">ETag: &quot;4215149735&quot;</span>
<span class="go">Last-Modified: Tue, 05 Jul 2022 16:11:47 GMT</span>
<span class="go">Content-Length: 389</span>
<span class="go">Connection: close</span>
<span class="go">Date: Wed, 06 Jul 2022 11:34:24 GMT</span>
<span class="go">Server: lighttpd/1.4.59</span>

<span class="go">&lt;!DOCTYPE html&gt;</span>
<span class="go">&lt;html&gt;</span>
<span class="go">&lt;head&gt;</span>
<span class="go">&lt;title&gt;Welcome to test.multipath-tcp.org!&lt;/title&gt;</span>
<span class="go">&lt;style&gt;</span>
<span class="go">body {</span>
<span class="go">width: 35em;</span>
<span class="go">margin: 0 auto;</span>
<span class="go">font-family: Tahoma, Verdana, Arial, sans-serif;</span>
<span class="go">}</span>
<span class="go">&lt;/style&gt;</span>
<span class="go">&lt;/head&gt;</span>
<span class="go">&lt;body&gt;</span>
<span class="go">&lt;h1&gt;Welcome to test.multipath-tcp.org !&lt;/h1&gt;</span>
<span class="go">&lt;p&gt;This web server runs Multipath TCP v1&lt;/p&gt;</span>

<span class="go">&lt;p&gt;&lt;em&gt;Thank you for using Multipath TCP.&lt;/em&gt;&lt;/p&gt;</span>
<span class="go">&lt;/body&gt;</span>
<span class="go">&lt;/html&gt;</span>
</pre></div>
</div>
<p>You should get the same result when using the second interface, IP address <code class="docutils literal notranslate"><span class="pre">192.168.0.43</span></code> in our example.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">echo -e &quot;GET / HTTP/1.0\r\n&quot; | nc -4 -s 192.168.0.43 test.multipath-tcp.org 80</span>
</pre></div>
</div>
<p>The next step is to verify that Multipath TCP is working correctly and that two subflows are created. For this, we'll use the <code class="docutils literal notranslate"><span class="pre">-i</span></code> parameter of <code class="docutils literal notranslate"><span class="pre">nc</span></code> to add a delay between the two lines of the HTTP GET. We will leverage this delay to check that MPTCP is correctly working using <code class="docutils literal notranslate"><span class="pre">ss</span></code> or <code class="docutils literal notranslate"><span class="pre">tcpdump</span></code></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">echo -e &quot;GET / HTTP/1.0\r\n&quot; | mptcpize run nc -4 -i 5 test.multipath-tcp.org 80</span>
</pre></div>
</div>
<p>We can observe the creation of the connection and the subflow using both <code class="docutils literal notranslate"><span class="pre">ss</span></code> and <code class="docutils literal notranslate"><span class="pre">tcpdump</span></code>. <code class="docutils literal notranslate"><span class="pre">ss</span></code> shows that there are two subflows towards <code class="docutils literal notranslate"><span class="pre">test.multipath-tcp.org</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ss -4 -iatM  dst test.multipath-tcp.org</span>
<span class="go">Netid  State  Recv-Q  Send-Q         Local Address:Port      Peer Address:Port  Process</span>
<span class="go">tcp    ESTAB  0       0        192.168.0.43%wlp3s0:34801     5.196.67.207:http</span>
<span class="go">      cubic wscale:7,7 rto:220 rtt:17.439/8.719 mss:1448 pmtu:1500 rcvmss:536 advmss:1448 cwnd:10 bytes_acked:1 segs_out:2 segs_in:2 send 6.64Mbps lastsnd:1776 lastrcv:1776 lastack:1764 pacing_rate 13.3Mbps delivered:1 rcv_space:14480 rcv_ssthresh:64088 minrtt:17.439</span>
<span class="go">tcp    ESTAB  0       0               192.168.0.37:47672     5.196.67.207:http</span>
<span class="go">      cubic wscale:7,7 rto:216 rtt:14/5.405 mss:1448 pmtu:1500 rcvmss:536 advmss:1448 cwnd:10 bytes_sent:16 bytes_acked:17 segs_out:3 segs_in:3 data_segs_out:1 send 8.27Mbps lastsnd:1808 lastrcv:1808 lastack:1792 pacing_rate 16.5Mbps delivery_rate 790kbps delivered:2 busy:16ms rcv_space:14480 rcv_ssthresh:64088 minrtt:13.905</span>
<span class="go">mptcp  ESTAB  0       0               192.168.0.37:47672     5.196.67.207:http</span>
<span class="go">      subflows:1 subflows_max:8 remote_key token:e1e3cdeb write_seq:1045ecfa3f05f4ea snd_una:1045ecfa3f05f4ea rcv_nxt:d0568f430363c9aa</span>
</pre></div>
</div>
<p>The line starting with <code class="docutils literal notranslate"><span class="pre">mptcp</span></code> indicates that the Multipath TCP connection above has one additional subflow.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">tcpdump</span></code> output reveals precisely which packets have been sent over each network interface.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo tcpdump -n -i any host test.multipath-tcp.org and port 80tcpdump: data link type LINUX_SLL2</span>
<span class="go">tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span>
<span class="go">listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes</span>
<span class="go">13:43:26.620667 enp2s0 Out IP 192.168.0.37.47672 &gt; 5.196.67.207.80: Flags [S], seq 3585891423, win 64240, options [mss 1460,sackOK,TS val 3993892549 ecr 0,nop,wscale 7,mptcp capable v1], length 0</span>
<span class="go">13:43:26.634537 enp2s0 In  IP 5.196.67.207.80 &gt; 192.168.0.37.47672: Flags [S.], seq 1788691420, ack 3585891424, win 65160, options [mss 1460,sackOK,TS val 1030255900 ecr 3993892549,nop,wscale 7,mptcp capable v1 {0x54f04ad5bd2d9f42}], length 0</span>
<span class="go">13:43:26.634609 enp2s0 Out IP 192.168.0.37.47672 &gt; 5.196.67.207.80: Flags [.], ack 1, win 502, options [nop,nop,TS val 3993892563 ecr 1030255900,mptcp capable v1 {0xff2ec3a2f6151881,0x54f04ad5bd2d9f42}], length 0</span>
<span class="go">13:43:26.634718 enp2s0 Out IP 192.168.0.37.47672 &gt; 5.196.67.207.80: Flags [P.], seq 1:17, ack 1, win 502, options [nop,nop,TS val 3993892563 ecr 1030255900,mptcp capable v1 {0xff2ec3a2f6151881,0x54f04ad5bd2d9f42},nop,nop], length 16: HTTP: GET / HTTP/1.0</span>
<span class="go">13:43:26.649351 enp2s0 In  IP 5.196.67.207.80 &gt; 192.168.0.37.47672: Flags [.], ack 17, win 509, options [nop,nop,TS val 1030255916 ecr 3993892563,mptcp dss ack 1172603837543216362], length 0</span>
<span class="go">13:43:26.649351 enp2s0 In  IP 5.196.67.207.80 &gt; 192.168.0.37.47672: Flags [.], ack 17, win 509, options [nop,nop,TS val 1030255916 ecr 3993892563,mptcp dss ack 1172603837543216362], length 0</span>
<span class="go">13:43:26.649498 wlp3s0 Out IP 192.168.0.43.34801 &gt; 5.196.67.207.80: Flags [S], seq 2321572505, win 64240, options [mss 1460,sackOK,TS val 1218002018 ecr 0,nop,wscale 7,mptcp join id 8 token 0xeef7df2f nonce 0xc0d346f6], length 0</span>
<span class="go">13:43:26.666895 wlp3s0 In  IP 5.196.67.207.80 &gt; 192.168.0.43.34801: Flags [S.], seq 1973196884, ack 2321572506, win 65160, options [mss 1460,sackOK,TS val 1030255931 ecr 1218002018,nop,wscale 7,mptcp join id 0 hmac 0xc7489cf7056428b4 nonce 0xa54f9af], length 0</span>
<span class="go">13:43:26.666966 wlp3s0 Out IP 192.168.0.43.34801 &gt; 5.196.67.207.80: Flags [.], ack 1, win 502, options [nop,nop,TS val 1218002035 ecr 1030255931,mptcp join hmac 0xb4e6a41bf5861313df7f5f454966998ad7e698a4], length 0</span>
<span class="go">13:43:26.677776 wlp3s0 In  IP 5.196.67.207.80 &gt; 192.168.0.43.34801: Flags [.], ack 1, win 510, options [nop,nop,TS val 1030255944 ecr 1218002035,mptcp dss ack 1172603837543216362], length 0</span>
<span class="go">13:43:31.635023 enp2s0 Out IP 192.168.0.37.47672 &gt; 5.196.67.207.80: Flags [P.], seq 17:18, ack 1, win 502, options [nop,nop,TS val 3993897563 ecr 1030255916,mptcp dss ack 56871338 seq 1172603837543216362 subseq 17 len 1,nop,nop], length 1: HTTP</span>
<span class="go">13:43:31.646703 enp2s0 In  IP 5.196.67.207.80 &gt; 192.168.0.37.47672: Flags [.], ack 18, win 509, options [nop,nop,TS val 1030260913 ecr 3993897563,mptcp dss ack 1172603837543216363], length 0</span>
<span class="go">13:43:31.647276 enp2s0 In  IP 5.196.67.207.80 &gt; 192.168.0.37.47672: Flags [P.], seq 1:602, ack 18, win 509, options [nop,nop,TS val 1030260914 ecr 3993897563,mptcp dss ack 1172603837543216363 seq 15012343925868579242 subseq 1 len 601,nop,nop], length 601: HTTP: HTTP/1.0 200 OK</span>
<span class="go">13:43:31.647300 enp2s0 Out IP 192.168.0.37.47672 &gt; 5.196.67.207.80: Flags [.], ack 602, win 501, options [nop,nop,TS val 3993897576 ecr 1030260914,mptcp dss ack 15012343925868579843], length 0</span>
<span class="go">13:43:31.647276 enp2s0 In  IP 5.196.67.207.80 &gt; 192.168.0.37.47672: Flags [.], ack 18, win 509, options [nop,nop,TS val 1030260914 ecr 3993897563,mptcp dss fin ack 1172603837543216363 seq 15012343925868579843 subseq 0 len 1,nop,nop], length 0</span>
<span class="go">13:43:31.647321 enp2s0 Out IP 192.168.0.37.47672 &gt; 5.196.67.207.80: Flags [.], ack 602, win 501, options [nop,nop,TS val 3993897576 ecr 1030260914,mptcp dss ack 15012343925868579844], length 0</span>
<span class="go">13:43:31.647330 wlp3s0 Out IP 192.168.0.43.34801 &gt; 5.196.67.207.80: Flags [.], ack 1, win 502, options [nop,nop,TS val 1218002046 ecr 1030255944,mptcp dss ack 15012343925868579844], length 0</span>
<span class="go">13:43:31.648565 wlp3s0 In  IP 5.196.67.207.80 &gt; 192.168.0.43.34801: Flags [.], ack 1, win 510, options [nop,nop,TS val 1030255944 ecr 1218002035,mptcp dss fin ack 1172603837543216363 seq 15012343925868579843 subseq 0 len 1,nop,nop], length 0</span>
<span class="go">13:43:36.635392 enp2s0 Out IP 192.168.0.37.47672 &gt; 5.196.67.207.80: Flags [.], ack 602, win 501, options [nop,nop,TS val 3993897576 ecr 1030260914,mptcp dss fin ack 15012343925868579844 seq 1172603837543216363 subseq 0 len 1,nop,nop], length 0</span>
<span class="go">13:43:36.635416 wlp3s0 Out IP 192.168.0.43.34801 &gt; 5.196.67.207.80: Flags [.], ack 1, win 502, options [nop,nop,TS val 1218007017 ecr 1030255944,mptcp dss fin ack 15012343925868579844 seq 1172603837543216363 subseq 0 len 1,nop,nop], length 0</span>
<span class="go">13:43:36.636468 enp2s0 Out IP 192.168.0.37.47672 &gt; 5.196.67.207.80: Flags [.], ack 602, win 501, options [nop,nop,TS val 3993897576 ecr 1030260914,mptcp dss fin ack 15012343925868579844 seq 1172603837543216363 subseq 0 len 1,nop,nop], length 0</span>
<span class="go">13:43:36.636482 wlp3s0 Out IP 192.168.0.43.34801 &gt; 5.196.67.207.80: Flags [.], ack 1, win 502, options [nop,nop,TS val 1218007017 ecr 1030255944,mptcp dss fin ack 15012343925868579844 seq 1172603837543216363 subseq 0 len 1,nop,nop], length 0</span>
<span class="go">13:43:36.640425 enp2s0 Out IP 192.168.0.37.47672 &gt; 5.196.67.207.80: Flags [.], ack 602, win 501, options [nop,nop,TS val 3993897576 ecr 1030260914,mptcp dss fin ack 15012343925868579844 seq 1172603837543216363 subseq 0 len 1,nop,nop], length 0</span>
<span class="go">13:43:36.640431 wlp3s0 Out IP 192.168.0.43.34801 &gt; 5.196.67.207.80: Flags [.], ack 1, win 502, options [nop,nop,TS val 1218007017 ecr 1030255944,mptcp dss fin ack 15012343925868579844 seq 1172603837543216363 subseq 0 len 1,nop,nop], length 0</span>
<span class="go">13:43:36.645605 enp2s0 In  IP 5.196.67.207.80 &gt; 192.168.0.37.47672: Flags [.], ack 18, win 509, options [nop,nop,TS val 1030265912 ecr 3993897576,mptcp dss ack 1172603837543216364], length 0</span>
<span class="go">13:43:36.645659 enp2s0 Out IP 192.168.0.37.47672 &gt; 5.196.67.207.80: Flags [F.], seq 18, ack 602, win 501, options [nop,nop,TS val 3993902574 ecr 1030265912,mptcp dss ack 15012343925868579844], length 0</span>
<span class="go">13:43:36.645674 wlp3s0 Out IP 192.168.0.43.34801 &gt; 5.196.67.207.80: Flags [F.], seq 1, ack 1, win 502, options [nop,nop,TS val 1218012014 ecr 1030255944,mptcp dss ack 15012343925868579844], length 0</span>
<span class="go">13:43:36.646315 wlp3s0 In  IP 5.196.67.207.80 &gt; 192.168.0.43.34801: Flags [.], ack 1, win 510, options [nop,nop,TS val 1030260930 ecr 1218002046,mptcp dss ack 1172603837543216364], length 0</span>
<span class="go">13:43:36.647699 enp2s0 In  IP 5.196.67.207.80 &gt; 192.168.0.37.47672: Flags [F.], seq 602, ack 18, win 509, options [nop,nop,TS val 1030265912 ecr 3993897576,mptcp dss ack 1172603837543216364], length 0</span>
<span class="go">13:43:36.647718 enp2s0 Out IP 192.168.0.37.47672 &gt; 5.196.67.207.80: Flags [.], ack 603, win 501, options [nop,nop,TS val 3993902576 ecr 1030265912,mptcp dss ack 15012343925868579844], length 0</span>
<span class="go">13:43:36.648629 wlp3s0 In  IP 5.196.67.207.80 &gt; 192.168.0.43.34801: Flags [F.], seq 1, ack 1, win 510, options [nop,nop,TS val 1030265912 ecr 1218002046,mptcp dss ack 1172603837543216364], length 0</span>
<span class="go">13:43:36.648649 wlp3s0 Out IP 192.168.0.43.34801 &gt; 5.196.67.207.80: Flags [.], ack 2, win 502, options [nop,nop,TS val 1218012017 ecr 1030265912,mptcp dss ack 15012343925868579844], length 0</span>
<span class="go">13:43:36.657040 enp2s0 In  IP 5.196.67.207.80 &gt; 192.168.0.37.47672: Flags [.], ack 19, win 509, options [nop,nop,TS val 1030265923 ecr 3993902574,mptcp dss ack 1172603837543216364], length 0</span>
<span class="go">13:43:36.662211 wlp3s0 In  IP 5.196.67.207.80 &gt; 192.168.0.43.34801: Flags [.], ack 2, win 510, options [nop,nop,TS val 1030265928 ecr 1218012014,mptcp dss ack 1172603837543216364], length 0</span>
</pre></div>
</div>
<p>If your host is dual stack, you also need to do the same configuration for IPv6 as well. Our test host uses the following IPv6 addresses.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ip -6 addr show</span>
<span class="go">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 state UNKNOWN qlen 1000</span>
<span class="go">    inet6 ::1/128 scope host</span>
<span class="go">    valid_lft forever preferred_lft forever</span>
<span class="go">2: enp2s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 state UP qlen 1000</span>
<span class="go">    inet6 2a02:2788:10c4:123:f468:1851:9a9f:7d44/64 scope global temporary dynamic</span>
<span class="go">    valid_lft 592298sec preferred_lft 73422sec</span>
<span class="go">    inet6 2a02:2788:10c4:123:6636:10c6:692b:18cc/64 scope global dynamic mngtmpaddr noprefixroute</span>
<span class="go">    valid_lft 1209600sec preferred_lft 604800sec</span>
<span class="go">    inet6 fe80::5642:39bd:3390:43d3/64 scope link noprefixroute</span>
<span class="go">    valid_lft forever preferred_lft forever</span>
<span class="go">3: wlp3s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 state UP qlen 1000</span>
<span class="go">    inet6 2a02:2788:10c4:123:3d66:f590:d891:8fb3/64 scope global dynamic noprefixroute</span>
<span class="go">    valid_lft 1209600sec preferred_lft 604800sec</span>
<span class="go">    inet6 fe80::3934:7572:b1ff:b555/64 scope link noprefixroute</span>
<span class="go">    valid_lft forever preferred_lft forever</span>
</pre></div>
</div>
<p>We thus had to configure the following IPv6 routing tables. This is similar to the commands used to configure the IPv4 routing tables.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ip -6 rule add from 2a02:2788:10c4:123:6636:10c6:692b:18cc table 1</span>
<span class="go">ip -6 rule add from 2a02:2788:10c4:123:3d66:f590:d891:8fb3 table 2</span>
<span class="go">ip route add 2a02:2788:10c4:123::/64 dev enp2s0 scope link table 1</span>
<span class="go">ip route add 2a02:2788:10c4:123::/64 dev wlp3s0 scope link table 2</span>
<span class="go">ip route add default via fe80::10:18ff:fe07:fc33 dev enp2s0 table 1</span>
<span class="go">ip route add default via fe80::10:18ff:fe07:fc33 dev wlp3s0 table 2</span>
<span class="go">ip route add default scope global nexthop via fe80::10:18ff:fe07:fc33 dev enp2s0</span>
</pre></div>
</div>
<p>Remember that if you want to create subflows using IPv6 addresses, you also need to configure the stack with <code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">mptcp</span> <span class="pre">endpoint</span> <span class="pre">add</span></code> as you did for the IPv4 addresses.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The current versions of the Linux kernel only use one address family at a time. If a connection was created using IPv4, then only IPv4 addresses will be used to create new subflows. Future versions of the kernel will allow to mix IPv4 and IPv6 subflows.</p>
</div>
</section>
<section id="analyzing-the-output-of-ss">
<h2>Analyzing the output of ss<a class="headerlink" href="#analyzing-the-output-of-ss" title="Permalink to this headline"></a></h2>
</section>
<section id="analyzing-the-output-of-nstat">
<h2>Analyzing the output of nstat<a class="headerlink" href="#analyzing-the-output-of-nstat" title="Permalink to this headline"></a></h2>
<p>The Linux TCP/IP stack maintains a lot of counters that track various
events inside the kernel. These counters are very useful for system
administrators who need to manage Linux hosts and debug some specific
networking problems.</p>
<p>Linux supports a few hundred counters associated to the protocols in the
network and transport layers. Other operating systems have defined their
own counters to track similar networking events. Fortunately, the IETF
has standard some counters that are common to different operating
systems and TCP/IP implementations. These counters are exported as
variables which can be queried using a management protocol such as SNMP.
This enables a management server to collect statistics for a series of
hosts to process and analyze them.  Several versions of SNMP exist, but
we will not discuss them in details in this document. Instead, we
focus on the Linux TCP/IP implementation and explain the different counters
that the <a class="reference external" href="https://www.man7.org/linux/man-pages/man8/nstat.8.html">nstat</a>
application exposes to the user.</p>
<p>Linux kernel version 5.18 collects 363 different counters that are divided in 7 categories :</p>
<blockquote>
<div><ul class="simple">
<li><p>67 counters track the IPv4 implementation</p></li>
<li><p>80 counters track the ICMPv4 implementation</p></li>
<li><p>32 counters track the IPv6 implementation</p></li>
<li><p>46 counters track ICMPv6</p></li>
<li><p>135 counters track TCP</p></li>
<li><p>35 counters track UDP</p></li>
<li><p>46 counters track Multipath TCP</p></li>
</ul>
</div></blockquote>
<p>Some of these counters are part of the Management Information Bases (MIB) defined
within the IETF, e.g. <span class="target" id="index-0"></span><a class="rfc reference external" href="https://tools.ietf.org/html/rfc1213.html"><strong>RFC 1213</strong></a> for IPv4 and ICMPv4, <span class="target" id="index-1"></span><a class="rfc reference external" href="https://tools.ietf.org/html/rfc4293.html"><strong>RFC 4293</strong></a> for IPv6 and ICMPv6,  <span class="target" id="index-2"></span><a class="rfc reference external" href="https://tools.ietf.org/html/rfc4022.html"><strong>RFC 4022</strong></a> for TCP, <span class="target" id="index-3"></span><a class="rfc reference external" href="https://tools.ietf.org/html/rfc4113.html"><strong>RFC 4113</strong></a> for UDP. As of this writing, there is no official IETF MIB for Multipath TCP.</p>
<section id="using-nstat">
<h3>Using nstat<a class="headerlink" href="#using-nstat" title="Permalink to this headline"></a></h3>
<p>In this document, we describe the counters that are exposed by
<a class="reference external" href="https://www.man7.org/linux/man-pages/man8/nstat.8.html">nstat</a>
for the different protocols of the TCP/IP stack. Before discussing
these counters, it is useful to understand how
<a class="reference external" href="https://www.man7.org/linux/man-pages/man8/nstat.8.html">nstat</a> works.</p>
<p><a class="reference external" href="https://www.man7.org/linux/man-pages/man8/nstat.8.html">nstat</a> is a
command line tool that supports a small number of arguments</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nstat --help</span>
<span class="go">Usage: nstat [OPTION] [ PATTERN [ PATTERN ] ]</span>
<span class="go">       -h, --help            this message</span>
<span class="go">       -a, --ignore  ignore history</span>
<span class="go">       -d, --scan=SECS       sample every statistics every SECS</span>
<span class="go">       -j, --json            format output in JSON</span>
<span class="go">       -n, --nooutput        do history only</span>
<span class="go">       -p, --pretty  pretty print</span>
<span class="go">       -r, --reset           reset history</span>
<span class="go">       -s, --noupdate        don&#39;t update history</span>
<span class="go">       -t, --interval=SECS   report average over the last SECS</span>
<span class="go">       -V, --version output version information</span>
<span class="go">       -z, --zeros           show entries with zero activity</span>
</pre></div>
</div>
<p>By default, <a class="reference external" href="https://www.man7.org/linux/man-pages/man8/nstat.8.html">nstat</a>
displays the counters whose value has changed since the latest invocation
of the tool. This is usually a small subset of the counters
that depends on the networking activity of the host.</p>
<p><a class="reference external" href="https://www.man7.org/linux/man-pages/man8/nstat.8.html">nstat</a> can collect
historical information and provides average counters.</p>
<p><a class="reference external" href="https://www.man7.org/linux/man-pages/man8/nstat.8.html">nstat</a> can also list
the current value of the different counters.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span>nstat -az
<span class="gp">       #</span>kernel
<span class="go">       IpInReceives                    1073367            0.0</span>
<span class="go">       IpInHdrErrors                   0                  0.0</span>
<span class="go">       IpInAddrErrors                  0                  0.0</span>
<span class="go">       IpForwDatagrams                 0                  0.0</span>
<span class="go">       IpInUnknownProtos               0                  0.0</span>
<span class="go">       IpInDiscards                    0                  0.0</span>
<span class="go">       IpInDelivers                    1072518            0.0</span>
<span class="go">       IpOutRequests                   484889             0.0</span>
<span class="go">       IpOutDiscards                   0                  0.0</span>
<span class="go">       IpOutNoRoutes                   0                  0.0</span>
<span class="go">       IpReasmTimeout                  0                  0.0</span>
<span class="go">       IpReasmReqds                    0                  0.0</span>
<span class="go">       IpReasmOKs                      0                  0.0</span>
<span class="go">       IpReasmFails                    0                  0.0</span>
<span class="go">       IpFragOKs                       0                  0.0</span>
<span class="go">       IpFragFails                     0                  0.0</span>
<span class="go">       IpFragCreates                   0                  0.0</span>
<span class="go">       IcmpInMsgs                      561                0.0</span>
<span class="go">       IcmpInErrors                    125                0.0</span>
<span class="go">       IcmpInCsumErrors                0                  0.0</span>
<span class="go">       IcmpInDestUnreachs              6                  0.0</span>
<span class="go">       IcmpInTimeExcds                 125                0.0</span>
<span class="go">       IcmpInParmProbs                 0                  0.0</span>
<span class="go">       IcmpInSrcQuenchs                0                  0.0</span>
<span class="go">       IcmpInRedirects                 0                  0.0</span>
<span class="go">       IcmpInEchos                     298                0.0</span>
<span class="go">       IcmpInEchoReps                  0                  0.0</span>
<span class="go">       IcmpInTimestamps                33                 0.0</span>
<span class="go">       IcmpInTimestampReps             0                  0.0</span>
<span class="go">       IcmpInAddrMasks                 99                 0.0</span>
<span class="go">       IcmpInAddrMaskReps              0                  0.0</span>
<span class="go">       IcmpOutMsgs                     331                0.0</span>
<span class="go">       IcmpOutErrors                   0                  0.0</span>
<span class="go">       IcmpOutDestUnreachs             0                  0.0</span>
<span class="go">       IcmpOutTimeExcds                0                  0.0</span>
<span class="go">       IcmpOutParmProbs                0                  0.0</span>
<span class="go">       IcmpOutSrcQuenchs               0                  0.0</span>
<span class="go">       IcmpOutRedirects                0                  0.0</span>
<span class="go">       IcmpOutEchos                    0                  0.0</span>
<span class="go">       IcmpOutEchoReps                 298                0.0</span>
<span class="go">       IcmpOutTimestamps               0                  0.0</span>
<span class="go">       IcmpOutTimestampReps            33                 0.0</span>
<span class="go">       IcmpOutAddrMasks                0                  0.0</span>
<span class="go">       IcmpOutAddrMaskReps             0                  0.0</span>
<span class="go">       IcmpMsgInType3                  6                  0.0</span>
<span class="go">       IcmpMsgInType8                  298                0.0</span>
<span class="go">       IcmpMsgInType11                 125                0.0</span>
<span class="go">       IcmpMsgInType13                 33                 0.0</span>
<span class="go">       IcmpMsgInType17                 99                 0.0</span>
<span class="go">       IcmpMsgOutType0                 298                0.0</span>
<span class="go">       IcmpMsgOutType14                33                 0.0</span>
<span class="go">       TcpActiveOpens                  3330               0.0</span>
<span class="go">       TcpPassiveOpens                 252                0.0</span>
<span class="go">       TcpAttemptFails                 0                  0.0</span>
<span class="go">       TcpEstabResets                  78                 0.0</span>
<span class="go">       TcpInSegs                       3202615            0.0</span>
<span class="go">       TcpOutSegs                      6431616            0.0</span>
<span class="go">       TcpRetransSegs                  7584               0.0</span>
<span class="go">       TcpInErrs                       0                  0.0</span>
<span class="go">       TcpOutRsts                      102                0.0</span>
<span class="go">       TcpInCsumErrors                 0                  0.0</span>
<span class="go">       UdpInDatagrams                  18972              0.0</span>
<span class="go">       UdpNoPorts                      0                  0.0</span>
<span class="go">       UdpInErrors                     0                  0.0</span>
<span class="go">       UdpOutDatagrams                 19257              0.0</span>
<span class="go">       UdpRcvbufErrors                 0                  0.0</span>
<span class="go">       UdpSndbufErrors                 0                  0.0</span>
<span class="go">       UdpInCsumErrors                 0                  0.0</span>
<span class="go">       UdpIgnoredMulti                 19989              0.0</span>
<span class="go">       UdpMemErrors                    0                  0.0</span>
<span class="go">       UdpLiteInDatagrams              0                  0.0</span>
<span class="go">       UdpLiteNoPorts                  0                  0.0</span>
<span class="go">       UdpLiteInErrors                 0                  0.0</span>
<span class="go">       UdpLiteOutDatagrams             0                  0.0</span>
<span class="go">       UdpLiteRcvbufErrors             0                  0.0</span>
<span class="go">       UdpLiteSndbufErrors             0                  0.0</span>
<span class="go">       UdpLiteInCsumErrors             0                  0.0</span>
<span class="go">       UdpLiteIgnoredMulti             0                  0.0</span>
<span class="go">       UdpLiteMemErrors                0                  0.0</span>
<span class="go">       Ip6InReceives                   2198489            0.0</span>
<span class="go">       Ip6InHdrErrors                  0                  0.0</span>
<span class="go">       Ip6InTooBigErrors               0                  0.0</span>
<span class="go">       Ip6InNoRoutes                   200                0.0</span>
<span class="go">       Ip6InAddrErrors                 0                  0.0</span>
<span class="go">       Ip6InUnknownProtos              0                  0.0</span>
<span class="go">       Ip6InTruncatedPkts              0                  0.0</span>
<span class="go">       Ip6InDiscards                   0                  0.0</span>
<span class="go">       Ip6InDelivers                   2177604            0.0</span>
<span class="go">       Ip6OutForwDatagrams             0                  0.0</span>
<span class="go">       Ip6OutRequests                  1567967            0.0</span>
<span class="go">       Ip6OutDiscards                  0                  0.0</span>
<span class="go">       Ip6OutNoRoutes                  6                  0.0</span>
<span class="go">       Ip6ReasmTimeout                 0                  0.0</span>
<span class="go">       Ip6ReasmReqds                   0                  0.0</span>
<span class="go">       Ip6ReasmOKs                     0                  0.0</span>
<span class="go">       Ip6ReasmFails                   0                  0.0</span>
<span class="go">       Ip6FragOKs                      0                  0.0</span>
<span class="go">       Ip6FragFails                    0                  0.0</span>
<span class="go">       Ip6FragCreates                  0                  0.0</span>
<span class="go">       Ip6InMcastPkts                  20785              0.0</span>
<span class="go">       Ip6OutMcastPkts                 13                 0.0</span>
<span class="go">       Ip6InOctets                     2578707266         0.0</span>
<span class="go">       Ip6OutOctets                    3533261025         0.0</span>
<span class="go">       Ip6InMcastOctets                1442288            0.0</span>
<span class="go">       Ip6OutMcastOctets               1252               0.0</span>
<span class="go">       Ip6InBcastOctets                0                  0.0</span>
<span class="go">       Ip6OutBcastOctets               0                  0.0</span>
<span class="go">       Ip6InNoECTPkts                  2060704            0.0</span>
<span class="go">       Ip6InECT1Pkts                   0                  0.0</span>
<span class="go">       Ip6InECT0Pkts                   137799             0.0</span>
<span class="go">       Ip6InCEPkts                     0                  0.0</span>
<span class="go">       Icmp6InMsgs                     7525               0.0</span>
<span class="go">       Icmp6InErrors                   0                  0.0</span>
<span class="go">       Icmp6OutMsgs                    7511               0.0</span>
<span class="go">       Icmp6OutErrors                  0                  0.0</span>
<span class="go">       Icmp6InCsumErrors               0                  0.0</span>
<span class="go">       Icmp6InDestUnreachs             10                 0.0</span>
<span class="go">       Icmp6InPktTooBigs               0                  0.0</span>
<span class="go">       Icmp6InTimeExcds                0                  0.0</span>
<span class="go">       Icmp6InParmProblems             0                  0.0</span>
<span class="go">       Icmp6InEchos                    2                  0.0</span>
<span class="go">       Icmp6InEchoReplies              6                  0.0</span>
<span class="go">       Icmp6InGroupMembQueries         0                  0.0</span>
<span class="go">       Icmp6InGroupMembResponses       0                  0.0</span>
<span class="go">       Icmp6InGroupMembReductions      0                  0.0</span>
<span class="go">       Icmp6InRouterSolicits           0                  0.0</span>
<span class="go">       Icmp6InRouterAdvertisements     0                  0.0</span>
<span class="go">       Icmp6InNeighborSolicits         4316               0.0</span>
<span class="go">       Icmp6InNeighborAdvertisements   3189               0.0</span>
<span class="go">       Icmp6InRedirects                0                  0.0</span>
<span class="go">       Icmp6InMLDv2Reports             2                  0.0</span>
<span class="go">       Icmp6OutDestUnreachs            0                  0.0</span>
<span class="go">       Icmp6OutPktTooBigs              0                  0.0</span>
<span class="go">       Icmp6OutTimeExcds               0                  0.0</span>
<span class="go">       Icmp6OutParmProblems            0                  0.0</span>
<span class="go">       Icmp6OutEchos                   6                  0.0</span>
<span class="go">       Icmp6OutEchoReplies             2                  0.0</span>
<span class="go">       Icmp6OutGroupMembQueries        0                  0.0</span>
<span class="go">       Icmp6OutGroupMembResponses      0                  0.0</span>
<span class="go">       Icmp6OutGroupMembReductions     0                  0.0</span>
<span class="go">       Icmp6OutRouterSolicits          0                  0.0</span>
<span class="go">       Icmp6OutRouterAdvertisements    0                  0.0</span>
<span class="go">       Icmp6OutNeighborSolicits        3179               0.0</span>
<span class="go">       Icmp6OutNeighborAdvertisements  4316               0.0</span>
<span class="go">       Icmp6OutRedirects               0                  0.0</span>
<span class="go">       Icmp6OutMLDv2Reports            8                  0.0</span>
<span class="go">       Icmp6InType1                    10                 0.0</span>
<span class="go">       Icmp6InType128                  2                  0.0</span>
<span class="go">       Icmp6InType129                  6                  0.0</span>
<span class="go">       Icmp6InType135                  4316               0.0</span>
<span class="go">       Icmp6InType136                  3189               0.0</span>
<span class="go">       Icmp6InType143                  2                  0.0</span>
<span class="go">       Icmp6OutType128                 6                  0.0</span>
<span class="go">       Icmp6OutType129                 2                  0.0</span>
<span class="go">       Icmp6OutType135                 3179               0.0</span>
<span class="go">       Icmp6OutType136                 4316               0.0</span>
<span class="go">       Icmp6OutType143                 8                  0.0</span>
<span class="go">       Udp6InDatagrams                 460                0.0</span>
<span class="go">       Udp6NoPorts                     0                  0.0</span>
<span class="go">       Udp6InErrors                    0                  0.0</span>
<span class="go">       Udp6OutDatagrams                95                 0.0</span>
<span class="go">       Udp6RcvbufErrors                0                  0.0</span>
<span class="go">       Udp6SndbufErrors                0                  0.0</span>
<span class="go">       Udp6InCsumErrors                0                  0.0</span>
<span class="go">       Udp6IgnoredMulti                0                  0.0</span>
<span class="go">       Udp6MemErrors                   0                  0.0</span>
<span class="go">       UdpLite6InDatagrams             0                  0.0</span>
<span class="go">       UdpLite6NoPorts                 0                  0.0</span>
<span class="go">       UdpLite6InErrors                0                  0.0</span>
<span class="go">       UdpLite6OutDatagrams            0                  0.0</span>
<span class="go">       UdpLite6RcvbufErrors            0                  0.0</span>
<span class="go">       UdpLite6SndbufErrors            0                  0.0</span>
<span class="go">       UdpLite6InCsumErrors            0                  0.0</span>
<span class="go">       UdpLite6MemErrors               0                  0.0</span>
<span class="go">       TcpExtSyncookiesSent            0                  0.0</span>
<span class="go">       TcpExtSyncookiesRecv            0                  0.0</span>
<span class="go">       TcpExtSyncookiesFailed          0                  0.0</span>
<span class="go">       TcpExtEmbryonicRsts             0                  0.0</span>
<span class="go">       TcpExtPruneCalled               3791               0.0</span>
<span class="go">       TcpExtRcvPruned                 0                  0.0</span>
<span class="go">       TcpExtOfoPruned                 0                  0.0</span>
<span class="go">       TcpExtOutOfWindowIcmps          0                  0.0</span>
<span class="go">       TcpExtLockDroppedIcmps          0                  0.0</span>
<span class="go">       TcpExtArpFilter                 0                  0.0</span>
<span class="go">       TcpExtTW                        2283               0.0</span>
<span class="go">       TcpExtTWRecycled                0                  0.0</span>
<span class="go">       TcpExtTWKilled                  0                  0.0</span>
<span class="go">       TcpExtPAWSActive                0                  0.0</span>
<span class="go">       TcpExtPAWSEstab                 11                 0.0</span>
<span class="go">       TcpExtDelayedACKs               31995              0.0</span>
<span class="go">       TcpExtDelayedACKLocked          47                 0.0</span>
<span class="go">       TcpExtDelayedACKLost            282                0.0</span>
<span class="go">       TcpExtListenOverflows           0                  0.0</span>
<span class="go">       TcpExtListenDrops               0                  0.0</span>
<span class="go">       TcpExtTCPHPHits                 699069             0.0</span>
<span class="go">       TcpExtTCPPureAcks               997468             0.0</span>
<span class="go">       TcpExtTCPHPAcks                 1235546            0.0</span>
<span class="go">       TcpExtTCPRenoRecovery           0                  0.0</span>
<span class="go">       TcpExtTCPSackRecovery           2526               0.0</span>
<span class="go">       TcpExtTCPSACKReneging           0                  0.0</span>
<span class="go">       TcpExtTCPSACKReorder            36858              0.0</span>
<span class="go">       TcpExtTCPRenoReorder            0                  0.0</span>
<span class="go">       TcpExtTCPTSReorder              85                 0.0</span>
<span class="go">       TcpExtTCPFullUndo               1                  0.0</span>
<span class="go">       TcpExtTCPPartialUndo            67                 0.0</span>
<span class="go">       TcpExtTCPDSACKUndo              11                 0.0</span>
<span class="go">       TcpExtTCPLossUndo               0                  0.0</span>
<span class="go">       TcpExtTCPLostRetransmit         184                0.0</span>
<span class="go">       TcpExtTCPRenoFailures           0                  0.0</span>
<span class="go">       TcpExtTCPSackFailures           0                  0.0</span>
<span class="go">       TcpExtTCPLossFailures           0                  0.0</span>
<span class="go">       TcpExtTCPFastRetrans            7084               0.0</span>
<span class="go">       TcpExtTCPSlowStartRetrans       0                  0.0</span>
<span class="go">       TcpExtTCPTimeouts               168                0.0</span>
<span class="go">       TcpExtTCPLossProbes             345                0.0</span>
<span class="go">       TcpExtTCPLossProbeRecovery      82                 0.0</span>
<span class="go">       TcpExtTCPRenoRecoveryFail       0                  0.0</span>
<span class="go">       TcpExtTCPSackRecoveryFail       0                  0.0</span>
<span class="go">       TcpExtTCPRcvCollapsed           0                  0.0</span>
<span class="go">       TcpExtTCPBacklogCoalesce        10938              0.0</span>
<span class="go">       TcpExtTCPDSACKOldSent           300                0.0</span>
<span class="go">       TcpExtTCPDSACKOfoSent           49                 0.0</span>
<span class="go">       TcpExtTCPDSACKRecv              317                0.0</span>
<span class="go">       TcpExtTCPDSACKOfoRecv           2                  0.0</span>
<span class="go">       TcpExtTCPAbortOnData            25                 0.0</span>
<span class="go">       TcpExtTCPAbortOnClose           54                 0.0</span>
<span class="go">       TcpExtTCPAbortOnMemory          0                  0.0</span>
<span class="go">       TcpExtTCPAbortOnTimeout         4                  0.0</span>
<span class="go">       TcpExtTCPAbortOnLinger          0                  0.0</span>
<span class="go">       TcpExtTCPAbortFailed            0                  0.0</span>
<span class="go">       TcpExtTCPMemoryPressures        0                  0.0</span>
<span class="go">       TcpExtTCPMemoryPressuresChrono  0                  0.0</span>
<span class="go">       TcpExtTCPSACKDiscard            0                  0.0</span>
<span class="go">       TcpExtTCPDSACKIgnoredOld        2                  0.0</span>
<span class="go">       TcpExtTCPDSACKIgnoredNoUndo     272                0.0</span>
<span class="go">       TcpExtTCPSpuriousRTOs           0                  0.0</span>
<span class="go">       TcpExtTCPMD5NotFound            0                  0.0</span>
<span class="go">       TcpExtTCPMD5Unexpected          0                  0.0</span>
<span class="go">       TcpExtTCPMD5Failure             0                  0.0</span>
<span class="go">       TcpExtTCPSackShifted            34290              0.0</span>
<span class="go">       TcpExtTCPSackMerged             11301              0.0</span>
<span class="go">       TcpExtTCPSackShiftFallback      40480              0.0</span>
<span class="go">       TcpExtTCPBacklogDrop            0                  0.0</span>
<span class="go">       TcpExtPFMemallocDrop            0                  0.0</span>
<span class="go">       TcpExtTCPMinTTLDrop             0                  0.0</span>
<span class="go">       TcpExtTCPDeferAcceptDrop        0                  0.0</span>
<span class="go">       TcpExtIPReversePathFilter       0                  0.0</span>
<span class="go">       TcpExtTCPTimeWaitOverflow       0                  0.0</span>
<span class="go">       TcpExtTCPReqQFullDoCookies      0                  0.0</span>
<span class="go">       TcpExtTCPReqQFullDrop           0                  0.0</span>
<span class="go">       TcpExtTCPRetransFail            0                  0.0</span>
<span class="go">       TcpExtTCPRcvCoalesce            100585             0.0</span>
<span class="go">       TcpExtTCPOFOQueue               15954              0.0</span>
<span class="go">       TcpExtTCPOFODrop                0                  0.0</span>
<span class="go">       TcpExtTCPOFOMerge               38                 0.0</span>
<span class="go">       TcpExtTCPChallengeACK           0                  0.0</span>
<span class="go">       TcpExtTCPSYNChallenge           0                  0.0</span>
<span class="go">       TcpExtTCPFastOpenActive         0                  0.0</span>
<span class="go">       TcpExtTCPFastOpenActiveFail     0                  0.0</span>
<span class="go">       TcpExtTCPFastOpenPassive        0                  0.0</span>
<span class="go">       TcpExtTCPFastOpenPassiveFail    0                  0.0</span>
<span class="go">       TcpExtTCPFastOpenListenOverflow 0                  0.0</span>
<span class="go">       TcpExtTCPFastOpenCookieReqd     0                  0.0</span>
<span class="go">       TcpExtTCPFastOpenBlackhole      0                  0.0</span>
<span class="go">       TcpExtTCPSpuriousRtxHostQueues  0                  0.0</span>
<span class="go">       TcpExtBusyPollRxPackets         0                  0.0</span>
<span class="go">       TcpExtTCPAutoCorking            73847              0.0</span>
<span class="go">       TcpExtTCPFromZeroWindowAdv      40                 0.0</span>
<span class="go">       TcpExtTCPToZeroWindowAdv        40                 0.0</span>
<span class="go">       TcpExtTCPWantZeroWindowAdv      2870               0.0</span>
<span class="go">       TcpExtTCPSynRetrans             91                 0.0</span>
<span class="go">       TcpExtTCPOrigDataSent           5948573            0.0</span>
<span class="go">       TcpExtTCPHystartTrainDetect     34                 0.0</span>
<span class="go">       TcpExtTCPHystartTrainCwnd       1880               0.0</span>
<span class="go">       TcpExtTCPHystartDelayDetect     3                  0.0</span>
<span class="go">       TcpExtTCPHystartDelayCwnd       261                0.0</span>
<span class="go">       TcpExtTCPACKSkippedSynRecv      0                  0.0</span>
<span class="go">       TcpExtTCPACKSkippedPAWS         9                  0.0</span>
<span class="go">       TcpExtTCPACKSkippedSeq          11                 0.0</span>
<span class="go">       TcpExtTCPACKSkippedFinWait2     0                  0.0</span>
<span class="go">       TcpExtTCPACKSkippedTimeWait     0                  0.0</span>
<span class="go">       TcpExtTCPACKSkippedChallenge    0                  0.0</span>
<span class="go">       TcpExtTCPWinProbe               0                  0.0</span>
<span class="go">       TcpExtTCPKeepAlive              67                 0.0</span>
<span class="go">       TcpExtTCPMTUPFail               0                  0.0</span>
<span class="go">       TcpExtTCPMTUPSuccess            0                  0.0</span>
<span class="go">       TcpExtTCPDelivered              5951000            0.0</span>
<span class="go">       TcpExtTCPDeliveredCE            0                  0.0</span>
<span class="go">       TcpExtTCPAckCompressed          3021               0.0</span>
<span class="go">       TcpExtTCPZeroWindowDrop         0                  0.0</span>
<span class="go">       TcpExtTCPRcvQDrop               0                  0.0</span>
<span class="go">       TcpExtTCPWqueueTooBig           0                  0.0</span>
<span class="go">       TcpExtTCPFastOpenPassiveAltKey  0                  0.0</span>
<span class="go">       TcpExtTcpTimeoutRehash          72                 0.0</span>
<span class="go">       TcpExtTcpDuplicateDataRehash    0                  0.0</span>
<span class="go">       TcpExtTCPDSACKRecvSegs          371                0.0</span>
<span class="go">       TcpExtTCPDSACKIgnoredDubious    0                  0.0</span>
<span class="go">       TcpExtTCPMigrateReqSuccess      0                  0.0</span>
<span class="go">       TcpExtTCPMigrateReqFailure      0                  0.0</span>
<span class="go">       IpExtInNoRoutes                 0                  0.0</span>
<span class="go">       IpExtInTruncatedPkts            0                  0.0</span>
<span class="go">       IpExtInMcastPkts                62                 0.0</span>
<span class="go">       IpExtOutMcastPkts               24                 0.0</span>
<span class="go">       IpExtInBcastPkts                19989              0.0</span>
<span class="go">       IpExtOutBcastPkts               0                  0.0</span>
<span class="go">       IpExtInOctets                   533061309          0.0</span>
<span class="go">       IpExtOutOctets                  5153892360         0.0</span>
<span class="go">       IpExtInMcastOctets              7448               0.0</span>
<span class="go">       IpExtOutMcastOctets             3592               0.0</span>
<span class="go">       IpExtInBcastOctets              2082276            0.0</span>
<span class="go">       IpExtOutBcastOctets             0                  0.0</span>
<span class="go">       IpExtInCsumErrors               0                  0.0</span>
<span class="go">       IpExtInNoECTPkts                1073527            0.0</span>
<span class="go">       IpExtInECT1Pkts                 0                  0.0</span>
<span class="go">       IpExtInECT0Pkts                 0                  0.0</span>
<span class="go">       IpExtInCEPkts                   0                  0.0</span>
<span class="go">       IpExtReasmOverlaps              0                  0.0</span>
<span class="go">       MPTcpExtMPCapableSYNRX          0                  0.0</span>
<span class="go">       MPTcpExtMPCapableSYNTX          2203               0.0</span>
<span class="go">       MPTcpExtMPCapableSYNACKRX       2172               0.0</span>
<span class="go">       MPTcpExtMPCapableACKRX          0                  0.0</span>
<span class="go">       MPTcpExtMPCapableFallbackACK    0                  0.0</span>
<span class="go">       MPTcpExtMPCapableFallbackSYNACK 22                 0.0</span>
<span class="go">       MPTcpExtMPFallbackTokenInit     0                  0.0</span>
<span class="go">       MPTcpExtMPTCPRetrans            0                  0.0</span>
<span class="go">       MPTcpExtMPJoinNoTokenFound      0                  0.0</span>
<span class="go">       MPTcpExtMPJoinSynRx             0                  0.0</span>
<span class="go">       MPTcpExtMPJoinSynAckRx          0                  0.0</span>
<span class="go">       MPTcpExtMPJoinSynAckHMacFailure 0                  0.0</span>
<span class="go">       MPTcpExtMPJoinAckRx             0                  0.0</span>
<span class="go">       MPTcpExtMPJoinAckHMacFailure    0                  0.0</span>
<span class="go">       MPTcpExtDSSNotMatching          0                  0.0</span>
<span class="go">       MPTcpExtInfiniteMapRx           0                  0.0</span>
<span class="go">       MPTcpExtDSSNoMatchTCP           0                  0.0</span>
<span class="go">       MPTcpExtDataCsumErr             0                  0.0</span>
<span class="go">       MPTcpExtOFOQueueTail            0                  0.0</span>
<span class="go">       MPTcpExtOFOQueue                0                  0.0</span>
<span class="go">       MPTcpExtOFOMerge                0                  0.0</span>
<span class="go">       MPTcpExtNoDSSInWindow           0                  0.0</span>
<span class="go">       MPTcpExtDuplicateData           0                  0.0</span>
<span class="go">       MPTcpExtAddAddr                 0                  0.0</span>
<span class="go">       MPTcpExtEchoAdd                 0                  0.0</span>
<span class="go">       MPTcpExtPortAdd                 0                  0.0</span>
<span class="go">       MPTcpExtAddAddrDrop             0                  0.0</span>
<span class="go">       MPTcpExtMPJoinPortSynRx         0                  0.0</span>
<span class="go">       MPTcpExtMPJoinPortSynAckRx      0                  0.0</span>
<span class="go">       MPTcpExtMPJoinPortAckRx         0                  0.0</span>
<span class="go">       MPTcpExtMismatchPortSynRx       0                  0.0</span>
<span class="go">       MPTcpExtMismatchPortAckRx       0                  0.0</span>
<span class="go">       MPTcpExtRmAddr                  0                  0.0</span>
<span class="go">       MPTcpExtRmAddrDrop              0                  0.0</span>
<span class="go">       MPTcpExtRmSubflow               0                  0.0</span>
<span class="go">       MPTcpExtMPPrioTx                0                  0.0</span>
<span class="go">       MPTcpExtMPPrioRx                0                  0.0</span>
<span class="go">       MPTcpExtMPFailTx                0                  0.0</span>
<span class="go">       MPTcpExtMPFailRx                0                  0.0</span>
<span class="go">       MPTcpExtMPFastcloseTx           0                  0.0</span>
<span class="go">       MPTcpExtMPFastcloseRx           0                  0.0</span>
<span class="go">       MPTcpExtMPRstTx                 17                 0.0</span>
<span class="go">       MPTcpExtMPRstRx                 0                  0.0</span>
<span class="go">       MPTcpExtRcvPruned               0                  0.0</span>
<span class="go">       MPTcpExtSubflowStale            0                  0.0</span>
<span class="go">       MPTcpExtSubflowRecover          0                  0.0</span>
</pre></div>
</div>
<p>Among all these variables, the ones named <code class="docutils literal notranslate"><span class="pre">\*Ext\*</span></code> are Linux specific
variables that are not defined in IETF MIBs. The others are usually defined
in an IETF RFC. The counters maintained by the Linux kernel are defined in
<a class="reference external" href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/snmp.h">include/uapi/linux/snmp.h</a> and
<a class="reference external" href="https://github.com/torvalds/linux/blob/master/net/mptcp/mib.h">net/mptcp/mib.h</a> for the Multipath TCP counters.
Each of the counters exposed by <a class="reference external" href="https://www.man7.org/linux/man-pages/man8/nstat.8.html">nstat</a> correspond to one specific identifier
in the Linux kernel. For example, the beginning of the IP part of the
counters is defined as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">IPSTATS_MIB_NUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="cm">/* frequently written fields in fast path, kept in same cache line */</span><span class="w"></span>
<span class="w">     </span><span class="n">IPSTATS_MIB_INPKTS</span><span class="p">,</span><span class="w">                     </span><span class="cm">/* InReceives */</span><span class="w"></span>
<span class="w">     </span><span class="n">IPSTATS_MIB_INOCTETS</span><span class="p">,</span><span class="w">                   </span><span class="cm">/* InOctets */</span><span class="w"></span>
<span class="w">     </span><span class="n">IPSTATS_MIB_INDELIVERS</span><span class="p">,</span><span class="w">                 </span><span class="cm">/* InDelivers */</span><span class="w"></span>
<span class="w">     </span><span class="n">IPSTATS_MIB_OUTFORWDATAGRAMS</span><span class="p">,</span><span class="w">           </span><span class="cm">/* OutForwDatagrams */</span><span class="w"></span>
<span class="w">     </span><span class="n">IPSTATS_MIB_OUTPKTS</span><span class="p">,</span><span class="w">                    </span><span class="cm">/* OutRequests */</span><span class="w"></span>
<span class="w">     </span><span class="n">IPSTATS_MIB_OUTOCTETS</span><span class="p">,</span><span class="w">                  </span><span class="cm">/* OutOctets */</span><span class="w"></span>
<span class="w">     </span><span class="cm">/* other fields */</span><span class="w"></span>
</pre></div>
</div>
<p>Before looking at the precise meaning of each of the counters managed by
<a class="reference external" href="https://www.man7.org/linux/man-pages/man8/nstat.8.html">nstat</a>,
it is interesting to recall the definition of the Case diagrams. This graphical
representation of SNMP variables can be really useful to understand the
meaning of the Linux networking counters.</p>
</section>
<section id="the-case-diagrams">
<h3>The Case diagrams<a class="headerlink" href="#the-case-diagrams" title="Permalink to this headline"></a></h3>
<p>The <span class="target" id="index-4"></span>Case diagrams were introduced by Jeffrey Case and Craig
Partridge in 1989 in the paper <a class="reference external" href="https://doi.org/10.1145/66093.66094">Case diagrams: a first step to diagrammed
management information bases</a>.
This article describes a simple but powerful graphical representation
of the interactions among the different SNMP variables that a networking
stack maintains.</p>
<p>A <cite>Case diagram</cite> represents the flow of packets through a stack and the
different variables that are updated as the packet progress through the
stack. The incoming packets are represented as progressing from
the bottom layer of the stack to the upper layer, while the outgoing
packets are represented in the other direction. The progression of these
packets is represented using a large arrow. An horizontal line
that crosses this arrow indicates the point in the stack where the associated
SNMP counter is updated. A small that leaves the main packet processing
flow indicates a specific treatment for a packet and a counter
that is updated. In some cases, an arrow enters the main workflow and
updates the associated counter.</p>
<p>The original paper used the IP counters of the MIB-2 to illustrate the
<cite>Case diagrams</cite>. This figure is reproduced below in ASCII format to simplify
the updates to the document.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">                   Transport Layer</span>
<span class="go">-----------------------------------------------------</span>
<span class="go">                         /\</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go"> IpInDelivers +++++++++++++++</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go">                         |+-----------&gt; IpInUnknownProtos</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go"> IpInDiscards &lt;----------+|</span>
<span class="go">                         ||</span>
<span class="go">                         |&lt;----------------  IpReasmOKs</span>
<span class="go">                         ||                     /\</span>
<span class="go">                         ||   IpReasmFails  &lt;---+|</span>
<span class="go">                         ||                     ||</span>
<span class="go">                         |+--------------&gt; IpReasmReqds</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go"> IpForwDatagrams &lt;-------+|</span>
<span class="go">                         ||</span>
<span class="go">                         |+--------------&gt; IpInAddrErrors</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go"> IpInHdrErrors &lt;---------+|</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go">                      +++++++++++++++++++ IpInReceives</span>
<span class="go">                         ||</span>
<span class="go">-----------------------------------------------------</span>
<span class="go">                   Interface Layer</span>
</pre></div>
</div>
<p>The <cite>Case diagram</cite> above shows how the packets are processed by the
IP stack. First, the Interface layer extracts the payload of the
received frame and passes it to the IP layer. At this point, the
<code class="docutils literal notranslate"><span class="pre">IpInReceives</span></code> counter is incremented. The processing of the
IPv4 packet starts. First, the stack checks for errors inside the IPv4
header. If an error is detected in the IPv4 header, the packet is dropped
and <code class="docutils literal notranslate"><span class="pre">IpInHdrErrors</span></code> is incremented. Then, the destination address is checked.
If the address is incorrect, the packet processing stops and <code class="docutils literal notranslate"><span class="pre">IpInAddrErrors</span></code>
is incremented.</p>
<p>If IP forwarding is enabled and the packet is not destined to this host,
then the packet is forwarded using the FIB. The <code class="docutils literal notranslate"><span class="pre">IpForwDatagrams</span></code> counter
is incremented.</p>
<p>The next step is to check whether the received packet is a fragment of
a larger packet that needs to be reassembled. If the received packet is a
fragment, then the <code class="docutils literal notranslate"><span class="pre">IpReasmReqds</span></code> counter is incremented and the
packet passed through the reassembly process. This reassembly can take time
since more fragments can be required to recover a complete packet. If
the packet reassembly succeeds, then <code class="docutils literal notranslate"><span class="pre">IpReasmOKs</span></code> is incremented and
the processing of the full packet continues. If the reassembly fails, e.g.
because a fragment is missing before the timeout expires, then
<code class="docutils literal notranslate"><span class="pre">IpReamsFails</span></code> gets incremented.</p>
<p>A this point, the packets have almost finished to be processed by the
IP stack. Most packets will be delivered to the transport layer
and increment the <code class="docutils literal notranslate"><span class="pre">IpInDelivers</span></code> counter except if the IP queue becomes
full. In this case, the <code class="docutils literal notranslate"><span class="pre">IpInDiscards</span></code> counter is incremented.
The incoming packet could also be discarded if its <cite>Protocol</cite> field
does not match one of the transport layers supported by the stack
(i.e. UDP, TCP, DCCP, ...). In this case, the <code class="docutils literal notranslate"><span class="pre">IpInUnknownProtos</span></code>
counter is incremented.</p>
</section>
</section>
<section id="the-multipath-tcp-counters">
<h2>The Multipath TCP counters<a class="headerlink" href="#the-multipath-tcp-counters" title="Permalink to this headline"></a></h2>
<p>Linux version 5.18 maintains 46 counters for Multipath TCP. These counters
correspond to different parts of the protocol and can be organized in four
groups. The first group gathers the counters that are incremented when TCP
packets containing the <code class="docutils literal notranslate"><span class="pre">MP_CAPABLE</span></code> option are processed. The second group
gathers the counters that are incremented when processing packets with
the <code class="docutils literal notranslate"><span class="pre">MP_JOIN</span></code> option. The third group gathers the counters that are
modified when packets with the <code class="docutils literal notranslate"><span class="pre">ADD_ADDR</span></code>, <code class="docutils literal notranslate"><span class="pre">RM_ADDR</span></code> or <code class="docutils literal notranslate"><span class="pre">MP_PRIO</span></code> option
are processed. The fourth group gathers the remaining counters of the
Multipath TCP stack.</p>
<p>Two versions of Multipath TCP have been specified within the IETF. Version
0 was initially defined in <span class="target" id="index-5"></span><a class="rfc reference external" href="https://tools.ietf.org/html/rfc6824.html"><strong>RFC 6824</strong></a>. The off-tree but well
maintained set of patches distributed by
<a class="reference external" href="https://www.multipath-tcp.org">https://www.multipath-tcp.org</a> implemented
this version of Multipath TCP. Based on the experience gathered with this
implementation and also Apple's implementation, Multipath TCP evolved and
the IETF published version 1 in <span class="target" id="index-6"></span><a class="rfc reference external" href="https://tools.ietf.org/html/rfc8684.html"><strong>RFC 8684</strong></a>. The Multipath TCP counters
correspond to this version of Multipath TCP.</p>
<section id="the-mpcapable-counters">
<h3>The MPCapable counters<a class="headerlink" href="#the-mpcapable-counters" title="Permalink to this headline"></a></h3>
<p>This group gathers the following counters: <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableSYNRX</span></code>,
<code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableSYNTX</span></code>, <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableSYNACKRX</span></code>,
<code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableACKRX</span></code>, <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableFallbackACK</span></code>,
<code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableFallbackSYNACK</span></code> and <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPFallbackTokenInit</span></code>. They
relate to the establishment of the initial Multipath TCP subflow
which is described in the <a class="reference internal" href="mptcp.html#mptcp-initial-mptcp-handshake"><span class="std std-ref">The Multipath TCP handshake</span></a> section.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableSYNTX</span></code> counter is similar to the <code class="docutils literal notranslate"><span class="pre">TcpActiveOpens</span></code>
counter maintained by TCP. It counts the number of Multipath TCP connections
that this host has tried to establish. Its value will usually be much smaller than <code class="docutils literal notranslate"><span class="pre">TcpActiveOpens</span></code>. When a Multipath connection is initiated using the
<code class="docutils literal notranslate"><span class="pre">connect</span></code> system call, both <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableSYNTX</span></code> and
<code class="docutils literal notranslate"><span class="pre">TcpActiveOpens</span></code> are incremented. Although the name of the counter is
<code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableSYNTX</span></code>, it is only incremented once per Multipath
TCP connection if the <code class="docutils literal notranslate"><span class="pre">SYN</span></code> packet needs to be retransmitted.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableSYNACKRX</span></code> counter is incremented every time
a Multipath TCP connection is confirmed by the reception of a
<code class="docutils literal notranslate"><span class="pre">SYN+ACK</span></code> with the <code class="docutils literal notranslate"><span class="pre">MP_CAPABLE</span></code> option to a <code class="docutils literal notranslate"><span class="pre">SYN</span></code> packet
that it sent earlier. The value of this counter should be lower than
<code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableSYNTX</span></code> since only a subset of the connections initiated
by a host will typically reach a Multipath TCP compliant server.
If a client receives a <code class="docutils literal notranslate"><span class="pre">SYN+ACK</span></code> without the <code class="docutils literal notranslate"><span class="pre">MP_CAPABLE</span></code> option
in response to a <code class="docutils literal notranslate"><span class="pre">SYN</span></code> sent with the <code class="docutils literal notranslate"><span class="pre">MP_CAPABLE</span></code> option, then
the <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableFallbackSYNACK</span></code> counter is incremented. This
counter tracks the Multipath TCP connections that were forced to fall back
to regular TCP during the three-way handshake of the initial subflow.</p>
<p>On the other hand, the <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableSYNRX</span></code> counter tracks the
number of Multipath TCP connections that were accepted by the host.
Its value will usually be much smaller than <code class="docutils literal notranslate"><span class="pre">TcpPassiveOpens</span></code> which
tracks all accepted TCP connections. When a Multipath connection is accepted,
both <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableSYNRX</span></code> and <code class="docutils literal notranslate"><span class="pre">TcpPassiveOpens</span></code> are incremented.
As for <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableSYNTX</span></code>, the <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableSYNRX</span></code> counter is
only incremented once per connection and not each time a packet is received.
Upon reception of a <code class="docutils literal notranslate"><span class="pre">SYN</span></code> with the <code class="docutils literal notranslate"><span class="pre">MP_CAPABLE</span></code> option, a
Multipath TCP server returns a <code class="docutils literal notranslate"><span class="pre">SYN+ACK</span></code> with the <code class="docutils literal notranslate"><span class="pre">MP_CAPABLE</span></code>
option. The <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableACKRX</span></code> counter is incremented upon reception
of the third <code class="docutils literal notranslate"><span class="pre">ACK</span></code> containing the <code class="docutils literal notranslate"><span class="pre">MP_CAPABLE</span></code> option. If this option
is not present in this <code class="docutils literal notranslate"><span class="pre">ACK</span></code>, then the <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPCapableFallbackACK</span></code>
gets incremented.
If this counter increases, it probably indicates some interference with a
middlebox that injects acknowledgments during the three-way handshake.</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-number">Listing 2 </span><span class="caption-text">The MPCapable counters (active opens)</span><a class="headerlink" href="#id15" title="Permalink to this code"></a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go"> MPTcpExtMPCapableSYNTX+++++++++++++++</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go">                         |+-----------&gt; MPTcpExtMPCapableSYNACKRX</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go">                         |+-----------&gt; MPTcpExtMPCapableFallbackSYNACK</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-number">Listing 3 </span><span class="caption-text">The MPCapable counters (passive opens)</span><a class="headerlink" href="#id16" title="Permalink to this code"></a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go"> MPTcpExtMPCapableSYNRX+++++++++++++++</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go">                         |+-----------&gt; MPTcpExtMPCapableACKRX</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go">                         |+-----------&gt; MPTcpExtMPCapableFallbackACK</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
</pre></div>
</div>
</div>
</section>
<section id="the-join-counters">
<h3>The Join counters<a class="headerlink" href="#the-join-counters" title="Permalink to this headline"></a></h3>
<p>There are thirteen counters in this group. They are incremented when a host
processes <code class="docutils literal notranslate"><span class="pre">SYN</span></code> packets corresponding to additional subflows.</p>
<p>The first counter, <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPJoinSynRx</span></code> is incremented every time a
<code class="docutils literal notranslate"><span class="pre">SYN</span></code> packet with the <code class="docutils literal notranslate"><span class="pre">MP_JOIN</span></code> option is received. Upon reception
of a such packet, the host first verifies that it knows the token of
the Multipath TCP connection. If so, the processing continues and
the host returns a <code class="docutils literal notranslate"><span class="pre">SYN+ACK</span></code> packet with the <code class="docutils literal notranslate"><span class="pre">MP_JOIN</span></code> option, its
random number and a HMAC. Otherwise, the <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPJoinNoTokenFound</span></code>
counter is incremented. The host then waits for the third <code class="docutils literal notranslate"><span class="pre">ACK</span></code>
which contains the <code class="docutils literal notranslate"><span class="pre">MP_JOIN</span></code> option and the HMAC computed by
the remote host. It then checks the validity of the received HMAC. If
the HMAC is invalid, then the <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPJoinAckHMacFailure</span></code> counter
is incremented.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPJoinSynRx</span></code> counter will increase on Multipath TCP hosts
that accept subflows, typically servers. The value of the
<code class="docutils literal notranslate"><span class="pre">MPTcpExtMPJoinACKRX</span></code> counter should be close to the previous one.
If the two other counters, <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPJoinNoTokenFound</span></code> or
<code class="docutils literal notranslate"><span class="pre">MPTcpExtMPJoinAckHMacFailure</span></code> increase, then the system administrator
should probably investigate as these are indication of possible attacks.</p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-number">Listing 4 </span><span class="caption-text">The Join counters when accepting subflows</span><a class="headerlink" href="#id17" title="Permalink to this code"></a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go"> MPTcpExtMPJoinSynRX +++++++++++++++</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go">                         |+-----------&gt; MPTcpExtMPJoinNoTokenFound</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go"> MPTcpExtMPJoinACKRX +++++++++++++++</span>
<span class="go">                         ||</span>
<span class="go">                         |+-----------&gt; MPTcpExtMPJoinAckHMacFailure</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
</pre></div>
</div>
</div>
<p>Unfortunately, there is no counter that tracks the creation of new subflows
by a host. The TCP stack counts these new subflows as active opens, but
there is no specific Multipath TCP counter. However, the
<code class="docutils literal notranslate"><span class="pre">MPTcpExtMPJoinSynAckRX</span></code> counter tracks the reception of <code class="docutils literal notranslate"><span class="pre">SYN+ACK</span></code>
packets containing the <code class="docutils literal notranslate"><span class="pre">MP_JOIN</span></code> option. This is thus an indirect
way to track the creation of new subflows. Upon reception of such a
packet, in response to a previously sent <code class="docutils literal notranslate"><span class="pre">SYN</span></code> packet with the <code class="docutils literal notranslate"><span class="pre">MP_JOIN</span></code>
option, a host checks the validity of the received HMAC. If the HMAC is
invalid, the <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPJoinSynAckHMacFailure</span></code> is incremented. This counter
should rarely increase. If it increases, then the problem should be
investigated by collecting packet traces.</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-number">Listing 5 </span><span class="caption-text">The Join counters when initiating subflows</span><a class="headerlink" href="#id18" title="Permalink to this code"></a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go"> MPTcpExtMPJoinSynAckRX +++++++++++++++</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
<span class="go">                         |+-----------&gt; MPTcpExtMPJoinSynAckHMacFailure</span>
<span class="go">                         ||</span>
<span class="go">                         ||</span>
</pre></div>
</div>
</div>
<p>A Multipath TCP host will usually accept additional subflows on the address
and ports where the initial subflow was accepted. The following counters
track the arrival of packets destined to different port numbers:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MPTcpExtMPJoinPortSynRx</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MPTcpExtMPJoinPortSynAckRx</span></code>
<code class="docutils literal notranslate"><span class="pre">MPTcpExtMPJoinPortAckRx</span></code></p></li>
</ul>
</div></blockquote>
<p>The last two counters, <code class="docutils literal notranslate"><span class="pre">MPTcpExtMismatchPortSynRx</span></code> and
<code class="docutils literal notranslate"><span class="pre">MPTcpExtMismatchPortAckRx</span></code> are a bit different. They are incremented when
a <code class="docutils literal notranslate"><span class="pre">SYN</span></code> or <code class="docutils literal notranslate"><span class="pre">ACK</span></code> sent to a different port number are received.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">MP_JOIN</span></code> option contains a <code class="docutils literal notranslate"><span class="pre">B</span></code> that indicates whether the new
subflow should be considered as a backup subflow or a regular one. This
information is used by the path manager, but no counter tracks the value of
the backup bit in the <code class="docutils literal notranslate"><span class="pre">MP_JOIN</span></code> option. Once a subflow has been established,
its backup status can be changed using the <code class="docutils literal notranslate"><span class="pre">MP_PRIO</span></code> option. The
<code class="docutils literal notranslate"><span class="pre">MPTcpExtMPPrioTx</span></code> counter is incremented every time such an option is sent.
The <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPPrioRx</span></code> counter is incremented by each received <code class="docutils literal notranslate"><span class="pre">MP_PRIO</span></code>
option.</p>
</section>
<section id="the-address-advertisement-counters">
<h3>The address advertisement counters<a class="headerlink" href="#the-address-advertisement-counters" title="Permalink to this headline"></a></h3>
<p>There are six counters in this group. The advertisement of addresses by
Multipath TCP is described in ref:<cite>Address management &lt;mmtpbook:mptcp-addr-management&gt;</cite>.</p>
<p>When a host receives a packet with a valid <code class="docutils literal notranslate"><span class="pre">ADD_ADDR</span></code> option with its
<code class="docutils literal notranslate"><span class="pre">Echo</span></code> bit set to zero, the <code class="docutils literal notranslate"><span class="pre">MPTcpExtAddAddr</span></code> counter is incremented.
If this option includes an optional port number, the <code class="docutils literal notranslate"><span class="pre">MPTcpExtPortAdd</span></code>
counter is also incremented. In addition to these two counters, the
<code class="docutils literal notranslate"><span class="pre">MPTcpExtAddAddrDrop</span></code> tracks the address advertisements that were received
by the host, but not processed by the path manager, e.g. because no user
space path manager was active.</p>
<p>Multipath TCP does not track the advertisements of addresses by sending
the <code class="docutils literal notranslate"><span class="pre">ADD_ADDR</span></code> option. However, it tracks the reception of packets
containing the <code class="docutils literal notranslate"><span class="pre">ADD_ADDR</span></code> option with the <code class="docutils literal notranslate"><span class="pre">Echo</span></code> bit set to one with
the <code class="docutils literal notranslate"><span class="pre">MPTcpExtEchoAdd</span></code> counter. These packets are echoed by the remote host.</p>
<p>Similarly, the <code class="docutils literal notranslate"><span class="pre">MPTcpExtRmAddr</span></code> counter tracks the number of received
<code class="docutils literal notranslate"><span class="pre">RM_ADDR</span></code> options. These options typically indicate a change in the
addresses owned by a remote peer. Mobile hosts are likely to send these
options when they move from one type of network to another. The
<code class="docutils literal notranslate"><span class="pre">MPTcpExtRmAddrDrop</span></code> is incremented when the path manager cannot process an
incoming <code class="docutils literal notranslate"><span class="pre">RM_ADDR</span></code> option.</p>
<p>When a host receives a <code class="docutils literal notranslate"><span class="pre">RM_ADDR</span></code> option from a remote peer, its path
manager should remove the subflows associated with this address. The
<code class="docutils literal notranslate"><span class="pre">MPTcpExtRmSubflow</span></code> counter tracks the number of subflows that have
been destroyed by a path manager.</p>
</section>
<section id="the-connection-termination-counters">
<h3>The connection termination counters<a class="headerlink" href="#the-connection-termination-counters" title="Permalink to this headline"></a></h3>
<p>There are seven counters in this group. They track the abnormal termination of
a Multipath TCP connection. A normal Multipath TCP connection should end
with the exchange of <code class="docutils literal notranslate"><span class="pre">DATA_FIN</span></code> in both directions. However, are scenarios
are possible. First, one of the hosts may wish to quickly terminate the
Multipath TCP connection without having to maintain state. Multipath TCP
uses the <code class="docutils literal notranslate"><span class="pre">FAST_CLOSE</span></code> option
in this case. The <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPFastcloseTx</span></code> and <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPFastcloseRx</span></code>
counters track the transmission and the reception of such options.</p>
<p>Multipath TCP was designed to prevent as much as possible interference
from middleboxes, but there are some types of interferences that force
Multipath TCP to fallback to regular TCP. In this case, the host that first
noticed the interference (e.g. problem during the handshake, DSS checksum
problem, ...) sends a packet with the <code class="docutils literal notranslate"><span class="pre">MP_FAIL</span></code> option. This forces the
Multipath TCP connection to fall back to a regular TCP connection.
The <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPFailTx</span></code> and <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPFailRx</span></code> counters track the
transmission and the reception of the <code class="docutils literal notranslate"><span class="pre">MP_FAIL</span></code> option. During some
types of fall backs, a host may also send an infinite DSS mapping. The
<code class="docutils literal notranslate"><span class="pre">MPTcpExtInfiniteMapRx</span></code> counter tracks the reception of such infinite
DSS mappings.</p>
<p>An increase of
these counters would indicate some type of middlebox interference which
should be investigated since it could prevent a complete utilization of
Multipath TCP.</p>
<p>Like TCP, Multipath TCP uses TCP <code class="docutils literal notranslate"><span class="pre">RST</span></code> to terminate subflows. Multipath
TCP also defines the <code class="docutils literal notranslate"><span class="pre">MP_TCPRST</span></code> option which can contain an option reason
code and flags indicating some information about the reason for the
transmission of the <code class="docutils literal notranslate"><span class="pre">RST</span></code>. The <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPRstTx</span></code> and <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPRstRx</span></code>
counters track the transmission and the reception of such <code class="docutils literal notranslate"><span class="pre">RST</span></code> packets.</p>
</section>
<section id="the-other-counters">
<h3>The other counters<a class="headerlink" href="#the-other-counters" title="Permalink to this headline"></a></h3>
<p>The remaining eleven counters are mainly related to processing of data.</p>
<p>If the DSS checksum is enabled, the <code class="docutils literal notranslate"><span class="pre">MPTcpExtDataCsumErr</span></code> is incremented
every time a check of the DSS checksum fails. This should be a rare event that
likely indicates the presence of middleboxes. It should be correlated with
the <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPFailTx</span></code> and <code class="docutils literal notranslate"><span class="pre">MPTcpExtMPFailRx</span></code> counters discussed in the
previous section.</p>
<p>Three counters track the DSS option of the incoming packets :
<code class="docutils literal notranslate"><span class="pre">MPTcpExtDSSNotMatching</span></code>, <code class="docutils literal notranslate"><span class="pre">MPTcpExtDSSNoMatchTCP</span></code> and
<code class="docutils literal notranslate"><span class="pre">MPTcpExtNoDSSInWindow</span></code>. The first counter is
incremented when a mapping is received for data that has already been mapped
and the new mapping is not the same as the existing one. The second counter
is incremented when the TCP sequence numbers found in the mapping do not
match with the current TCP sequence numbers. The third counter is incremented
upon reception of a packet that indicates a DSS option that is outside the
current window. These three counters should rarely increase.</p>
<p>The last counter that tracks data at the Multipath TCP connection
level is <code class="docutils literal notranslate"><span class="pre">MPTcpExtDuplicateData</span></code>. It counts the number of received
packets whose data has been ignored because it had already been received
earlier. Such duplicated data can occur with Multipath TCP when data
sent over a subflow is retransmitted over another subflow. It would
be interesting to follow the evolution of this counter on a server that
interacts with mobile devices.</p>
<p>Multipath TCP tracks losses on the subflows that compose a Multipath
TCP connection. If one subflow accumulates losses, it may be marked
as stale and the packet scheduler will stop using it to transmit data
until the losses have been recovered. The <code class="docutils literal notranslate"><span class="pre">MPTcpExtSubflowStale</span></code> counter is
incremented every time a subflow is marked as being stale. The
<code class="docutils literal notranslate"><span class="pre">MPTcpExtSubflowRecover</span></code> counter tracks the transitions from stale to
active.</p>
<p>Multipath TCP uses an out-of-order queue to reorder the data received over
the different subflows. The <code class="docutils literal notranslate"><span class="pre">MPTcpExtOFOQueueTail</span></code> and <code class="docutils literal notranslate"><span class="pre">MPTcpExtOFOQueue</span></code>   counters track the insertion of data at the tail and in the out-of-order
queue. The <code class="docutils literal notranslate"><span class="pre">MPTcpExtOFOMerge</span></code> is incremented when data present in the
out-or-order queue can be merged.</p>
<p>Finally, the <code class="docutils literal notranslate"><span class="pre">MPTcpExtRcvPruned</span></code> tracks the number of packets that
were dropped because the memory available for Multipath TCP was full.
If this counter increases, you should probably check the memory configuration
of your host.</p>
</section>
</section>
<section id="native-multipath-tcp-applications-on-linux">
<span id="native-apps-linux"></span><h2>Native Multipath TCP applications on Linux<a class="headerlink" href="#native-multipath-tcp-applications-on-linux" title="Permalink to this headline"></a></h2>
<p>On recent Linux kernels, Multipath TCP is enabled on a per-socket basis by passing <code class="docutils literal notranslate"><span class="pre">IP_PROTO_MPTCP</span></code> as the third parameter of the <code class="docutils literal notranslate"><span class="pre">socket</span></code> system call that creates the socket. This implies that existing applications that use TCP need to be changed to support Multipath TCP.</p>
<p>The <a class="reference external" href="https://github.com/mptcp-apps/mptcp-hello">mptcp-hello</a> project on <a class="reference external" href="https://github.com">GitHub</a> provides simple examples showing how to enable Multipath TCP on a TCP application in the following programming languages :</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://github.com/mptcp-apps/mptcp-hello/blob/main/c/README.md">C</a></p></li>
<li><p><a class="reference external" href="https://github.com/mptcp-apps/mptcp-hello/blob/main/python/README.md">Python</a></p></li>
<li><p><a class="reference external" href="https://github.com/mptcp-apps/mptcp-hello/blob/main/perl/README.md">Perl</a></p></li>
<li><p><a class="reference external" href="https://github.com/mptcp-apps/mptcp-hello/blob/main/rust/README.md">Rust</a></p></li>
</ul>
</div></blockquote>
<p>Patches have been proposed to add Multipath TCP support to the following applications :</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://github.com/mptcp-apps/iperf">iperf3</a></p></li>
<li><p><a class="reference external" href="https://github.com/mptcp-apps/openssh-portable/tree/mptcp_support">openssh</a></p></li>
<li><p><a class="reference external" href="https://github.com/mptcp-apps/wrk/tree/mptcp">wrk</a></p></li>
<li><p><a class="reference external" href="https://github.com/mptcp-apps/curl/tree/mptcp-clean">curl</a></p></li>
<li><p><a class="reference external" href="https://github.com/mptcp-apps/HTTPing/tree/mptcp">httping</a></p></li>
<li><p><a class="reference external" href="https://github.com/mptcp-apps/openvpn/tree/mptcp">openvpn</a></p></li>
</ul>
</div></blockquote>
<p>In addition some specific applications are developed with Multipath TCP support :</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://github.com/vanyingenzi/mftpclient">Minimal Multipath TCP capable FTP client in python</a></p></li>
</ul>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mptcp.html" class="btn btn-neutral float-left" title="Multipath TCP" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mptcp-apple.html" class="btn btn-neutral float-right" title="Multipath TCP on Apple devices" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Olivier Bonaventure.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>